from . import templates, views, actions, models

class MovieSearchStateView(templates.StateView):
    transitions = [
        {"text": (
        "üîç *–ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–∞*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞. üé¨\n\n"
        "*CinemaBot* –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª—é–±—ã—Ö —Ñ–∏–ª—å–º–∞—Ö, –≤–∫–ª—é—á–∞—è:\n"
        "üìÖ –î–∞—Ç—É –≤—ã—Ö–æ–¥–∞\n"
        "‚≠ê –†–µ–π—Ç–∏–Ω–≥ –∏ —Ä–µ—Ü–µ–Ω–∑–∏–∏\n"
        "üé• –¢—Ä–µ–π–ª–µ—Ä—ã\n"
        "üé≠ –°–æ—Å—Ç–∞–≤ –∞–∫—Ç–µ—Ä–æ–≤\n"
        "üì∞ –ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∂–∞–Ω—Ä–∞–º –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä –Ω–∏–∂–µ!"
    ), "field": "text"},
    ]
    redirect_to = views.MovieListView

    async def success(self, data): 
        typed_text = data["text"]
        
        async def items():
            found_movies = await actions.db.search(models.Movie, field="title", text=typed_text)
            inline_buttons = []
            for found_movie in found_movies:
                inline_buttons.append({"text": found_movie.title, "callback_data": f"movie_{found_movie.uuid.lower()}"})
            return inline_buttons

        async def message():
            found_movies_count = len(await items())
            if found_movies_count > 0:
                text = (
                    f"üé¨ **–ü–æ –∑–∞–ø—Ä–æ—Å—É** \"\u200B**{typed_text}**\u200B\" **–Ω–∞–π–¥–µ–Ω–æ** {found_movies_count} {'–∫–∏–Ω–æ—Ñ–∏–ª—å–º' if found_movies_count == 1 else '–∫–∏–Ω–æ—Ñ–∏–ª—å–º–æ–≤'}!\n"
                    f"üîç –í–æ—Ç —á—Ç–æ –º—ã –Ω–∞—à–ª–∏ –¥–ª—è –≤–∞—Å:\n"
                    f"‚úÖ –í—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è —Å —ç—Ç–∏–º –≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω—ã–º –∂–∞–Ω—Ä–æ–º!\n\n"
                    f"‚ú® –ö–∞–∂–¥–æ–µ –∏–∑ –Ω–∏—Ö ‚Äî —à–µ–¥–µ–≤—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç –≤–∞—à–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è! üåü"
                    )
            else:
                text = (
                    f"üòî **–ü–æ –∑–∞–ø—Ä–æ—Å—É** \"\u200B**{typed_text}**\u200B\" **–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!**\n\n"
                    f"üîç –ú—ã –ø–æ—Å—Ç–∞—Ä–∞–ª–∏—Å—å –Ω–∞–π—Ç–∏ –¥–ª—è –≤–∞—Å —á—Ç–æ-—Ç–æ –ø–æ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏.\n"
                    f"‚ú® –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é!\n"
                    f"üí° –ú–æ–∂–µ—Ç –±—ã—Ç—å, —Ö–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ? –ú—ã –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!"
                    )
            return text

        return {"items": await items(), "message": await message()}